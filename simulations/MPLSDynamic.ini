#
# Dynamic MPLS Network Configuration
# Features: Link failure simulation, congestion detection, dynamic path switching
#

#==============================================================================
# Common MPLS Configuration
#==============================================================================
[Config MPLSCommon]
# Base configuration for all MPLS simulations
abstract = true

# MPLS Configuration
**.ipv4.configurator.networkConfiguratorModule = ""

# Traffic Classification (DiffServ)
**.ppp[*].ingressTC.typename = "TC1"
**.ingressTC.numClasses = 3
**.ingressTC.classifier.filters = xmldoc("MPLSDynamic_filters.xml")
**.ingressTC.marker.dscps = "EF AF41 AF42"

# Queue Configuration
**.LER*.ppp[*].queue.typename = "DSQueue1"
**.CoreRouter*.ppp[*].queue.typename = "DSQueue1"
**.LER*.ppp[*].queue.packetCapacity = -1
**.LER*.ppp[*].queue.*.packetCapacity = -1
**.LER*.ppp[*].queue.wrr.weights = "6 3 1 0 0"
**.CoreRouter*.ppp[*].queue.wrr.weights = "6 3 1 0 0"

# RSVP-TE Configuration
**.LER*.rsvp.typename = "insotu.RsvpTeScriptable"
**.CoreRouter*.rsvp.typename = "insotu.RsvpTeScriptable"
**.LER*.classifier.typename = "insotu.RsvpClassifierScriptable"
**.CoreRouter*.classifier.typename = "insotu.RsvpClassifierScriptable"

# Disable automatic primary path restoration
*.LER*.autoRestorePrimary = false
*.CoreRouter*.autoRestorePrimary = false

# LSP Restoration Delay (wait for labels to be fully installed)
*.LER*.restorationDelay = 2s
*.CoreRouter*.restorationDelay = 2s

# RSVP-TE Fast Failure Detection and Recovery
**.LER*.rsvp.helloInterval = 0.1s
**.LER*.rsvp.helloTimeout = 0.4s
**.CoreRouter*.rsvp.helloInterval = 0.1s
**.CoreRouter*.rsvp.helloTimeout = 0.4s

# PPP interface configuration for graceful shutdown
**.ppp[*].ppp.stopOperationExtraTime = 0.5s

# Scenario support
*.*.hasStatus = true

# Statistics and Recording
**.scalar-recording = true
**.vector-recording = true
**.queue.queueLength.result-recording-modes = +vector
**.queue.queueingTime.result-recording-modes = +vector,+stats
# Exclude packet signals from vector recording (they cannot be converted to double)
**.app[*].packetSent:vector.result-recording-modes = -
**.app[*].packetReceived:vector.result-recording-modes = -
# Record only numeric statistics for applications
**.app[*].throughput:vector.result-recording-modes = +vector
**.app[*].rcvdPkLifetime:vector.result-recording-modes = +vector
**.app[*].sentPk:count.result-recording-modes = +last
**.app[*].rcvdPk:count.result-recording-modes = +last
**.ipv4.*.result-recording-modes = +stats
# Link utilization monitoring statistics
**.linkUtilMonitor*.linkUtilization:vector.result-recording-modes = +vector
**.linkUtilMonitor*.linkUtilization:stats.result-recording-modes = +stats

#==============================================================================
# Common Application Configuration
#==============================================================================
[Config ApplicationsCommon]
abstract = true

# Common application settings
**.Tx*.app[0].typename = "UdpBasicApp"
**.Tx*.app[0].startTime = 1s
**.Rx*.app[0].typename = "UdpSink"

# Tx1 -> Rx1 (High priority traffic on port 1000)
*.Tx1.numApps = 1
**.Tx1.app[0].localPort = 1000
**.Tx1.app[0].destPort = 1000
**.Tx1.app[0].messageLength = 1400 bytes
**.Tx1.app[0].sendInterval = 2ms
**.Tx1.app[0].destAddresses = "10.2.1.2"
**.Tx1.app[0].packetName = "HighPriority"
**.Rx1.numApps = 1
**.Rx1.app[0].localPort = 1000

# Tx2 -> Rx2 (Medium priority traffic on port 2000)
*.Tx2.numApps = 1
**.Tx2.app[0].localPort = 2000
**.Tx2.app[0].destPort = 2000
**.Tx2.app[0].messageLength = 1000 bytes
**.Tx2.app[0].sendInterval = 5ms
**.Tx2.app[0].destAddresses = "10.2.2.2"
**.Tx2.app[0].packetName = "MediumPriority"
**.Rx2.numApps = 1
**.Rx2.app[0].localPort = 2000

# Tx3 -> Rx3 (Low priority traffic on port 3000)
*.Tx3.numApps = 1
**.Tx3.app[0].localPort = 3000
**.Tx3.app[0].destPort = 3000
**.Tx3.app[0].messageLength = 800 bytes
**.Tx3.app[0].sendInterval = 10ms
**.Tx3.app[0].destAddresses = "10.2.3.2"
**.Tx3.app[0].packetName = "LowPriority"
**.Rx3.numApps = 1
**.Rx3.app[0].localPort = 3000

#==============================================================================
# MPLSDynamic Network Configuration
#==============================================================================
[Config MPLSDynamicBase]
extends = MPLSCommon, ApplicationsCommon
abstract = true
network = insotu.simulations.MPLSDynamic
sim-time-limit = 60s

# Visualization
**.visualizer.*.displayLinks = true
**.visualizer.*.displayRoutes = true
**.visualizer.dataLinkVisualizer.lineStyle = "solid"
**.visualizer.dataLinkVisualizer.lineOpacity = 1.0
**.visualizer.dataLinkVisualizer.fadeOutMode = "simulationTime"
**.visualizer.dataLinkVisualizer.fadeOutTime = 1s

# Network Configurator - DISABLED (using manual routing tables)
*.ipv4NetworkConfigurator.config = xmldoc("empty.xml")
*.ipv4NetworkConfigurator.addStaticRoutes = false
*.ipv4NetworkConfigurator.addDefaultRoutes = false
*.ipv4NetworkConfigurator.addSubnetRoutes = false
*.ipv4NetworkConfigurator.optimizeRoutes = false

# Router IDs (must match one of the interface addresses for RSVP-TE to work)
*.LER_Ingress.routerId = "10.1.3.1"
*.LER_Egress.routerId = "10.2.10.1"
*.CoreRouter1.routerId = "10.1.3.2"
*.CoreRouter2.routerId = "10.1.4.2"
*.CoreRouter3.routerId = "10.1.5.2"

# IP addresses are configured in routing table files (.rt)
# Routing files contain both ifconfig (interface configuration) and route sections

# RSVP-TE configuration for LER_Ingress
# peers = interfaces connected to other RSVP routers (not hosts)
**.LER_Ingress.peers = "ppp3 ppp4 ppp5"
**.LER_Ingress.rsvp.traffic = xmldoc("LER_Ingress_traffic.xml")
**.LER_Ingress.classifier.config = xmldoc("LER_Ingress_fec.xml")

# RSVP-TE configuration for Core Routers
**.CoreRouter1.peers = "ppp0 ppp1"
**.CoreRouter2.peers = "ppp0 ppp1"
**.CoreRouter3.peers = "ppp0 ppp1"

# RSVP-TE configuration for LER_Egress
**.LER_Egress.peers = "ppp3 ppp4 ppp5"

# Routing table files
**.LER_Ingress.ipv4.routingTable.routingFile = "LER_Ingress.rt"
**.LER_Egress.ipv4.routingTable.routingFile = "LER_Egress.rt"
**.CoreRouter1.ipv4.routingTable.routingFile = "CoreRouter1.rt"
**.CoreRouter2.ipv4.routingTable.routingFile = "CoreRouter2.rt"
**.CoreRouter3.ipv4.routingTable.routingFile = "CoreRouter3.rt"
**.Tx1.ipv4.routingTable.routingFile = "Tx1.rt"
**.Tx2.ipv4.routingTable.routingFile = "Tx2.rt"
**.Tx3.ipv4.routingTable.routingFile = "Tx3.rt"
**.Rx1.ipv4.routingTable.routingFile = "Rx1.rt"
**.Rx2.ipv4.routingTable.routingFile = "Rx2.rt"
**.Rx3.ipv4.routingTable.routingFile = "Rx3.rt"

# Scenario Configuration
**.scenarioManager.script = xmldoc("MPLSDynamic_scenario.xml")

# Application stop time
**.Tx*.app[0].stopTime = 59s

#==============================================================================
# Test Configurations
#==============================================================================

[General]
# Default configuration
network = insotu.simulations.MPLSDynamic
sim-time-limit = 60s
description = "Default: Test with link failure on primary path at t=20s"

# Include all common configurations
**.ipv4.configurator.networkConfiguratorModule = ""
**.ppp[*].ingressTC.typename = "TC1"
**.ingressTC.numClasses = 3
**.ingressTC.classifier.filters = xmldoc("MPLSDynamic_filters.xml")
**.ingressTC.marker.dscps = "EF AF41 AF42"
**.LER*.ppp[*].queue.typename = "DSQueue1"
**.CoreRouter*.ppp[*].queue.typename = "DSQueue1"
**.LER*.ppp[*].queue.packetCapacity = -1
**.LER*.ppp[*].queue.*.packetCapacity = -1
**.LER*.ppp[*].queue.wrr.weights = "5 4 3 2 1"
**.CoreRouter*.ppp[*].queue.wrr.weights = "5 4 3 2 1"
**.LER*.rsvp.typename = "insotu.RsvpTeScriptable"
**.CoreRouter*.rsvp.typename = "insotu.RsvpTeScriptable"
**.LER*.classifier.typename = "insotu.RsvpClassifierScriptable"
**.CoreRouter*.classifier.typename = "insotu.RsvpClassifierScriptable"
*.LER*.autoRestorePrimary = false
*.CoreRouter*.autoRestorePrimary = false
**.LER*.rsvp.helloInterval = 0.1s
**.LER*.rsvp.helloTimeout = 0.4s
**.CoreRouter*.rsvp.helloInterval = 0.1s
**.CoreRouter*.rsvp.helloTimeout = 0.4s
**.ppp[*].ppp.stopOperationExtraTime = 0.5s
*.*.hasStatus = true
**.scalar-recording = true
**.vector-recording = true
**.queue.queueLength.result-recording-modes = +vector
**.queue.queueingTime.result-recording-modes = +vector,+stats
# Exclude packet signals from vector recording (they cannot be converted to double)
**.app[*].packetSent:vector.result-recording-modes = -
**.app[*].packetReceived:vector.result-recording-modes = -
# Record only numeric statistics for applications
**.app[*].throughput:vector.result-recording-modes = +vector
**.app[*].rcvdPkLifetime:vector.result-recording-modes = +vector
**.app[*].sentPk:count.result-recording-modes = +last
**.app[*].rcvdPk:count.result-recording-modes = +last
**.ipv4.*.result-recording-modes = +stats

# Application settings
**.Tx*.app[0].typename = "UdpBasicApp"
**.Tx*.app[0].startTime = 1s
**.Rx*.app[0].typename = "UdpSink"
*.Tx1.numApps = 1
**.Tx1.app[0].localPort = 1000
**.Tx1.app[0].destPort = 1000
**.Tx1.app[0].messageLength = 1400 bytes
**.Tx1.app[0].sendInterval = 2ms
**.Tx1.app[0].destAddresses = "10.2.1.2"
**.Tx1.app[0].packetName = "HighPriority"
**.Tx1.app[0].stopTime = 59s
**.Rx1.numApps = 1
**.Rx1.app[0].localPort = 1000
*.Tx2.numApps = 1
**.Tx2.app[0].localPort = 2000
**.Tx2.app[0].destPort = 2000
**.Tx2.app[0].messageLength = 1000 bytes
**.Tx2.app[0].sendInterval = 5ms
**.Tx2.app[0].destAddresses = "10.2.2.2"
**.Tx2.app[0].packetName = "MediumPriority"
**.Tx2.app[0].stopTime = 59s
**.Rx2.numApps = 1
**.Rx2.app[0].localPort = 2000
*.Tx3.numApps = 1
**.Tx3.app[0].localPort = 3000
**.Tx3.app[0].destPort = 3000
**.Tx3.app[0].messageLength = 800 bytes
**.Tx3.app[0].sendInterval = 10ms
**.Tx3.app[0].destAddresses = "10.2.3.2"
**.Tx3.app[0].packetName = "LowPriority"
**.Tx3.app[0].stopTime = 59s
**.Rx3.numApps = 1
**.Rx3.app[0].localPort = 3000

# Visualization
**.visualizer.*.displayLinks = true
**.visualizer.*.displayRoutes = true

# Network Configurator - DISABLED (using manual routing tables)
*.ipv4NetworkConfigurator.config = xmldoc("empty.xml")
*.ipv4NetworkConfigurator.addStaticRoutes = false
*.ipv4NetworkConfigurator.addDefaultRoutes = false
*.ipv4NetworkConfigurator.addSubnetRoutes = false
*.ipv4NetworkConfigurator.optimizeRoutes = false

# Router IDs (must match one of the interface addresses for RSVP-TE to work)
*.LER_Ingress.routerId = "10.1.3.1"
*.LER_Egress.routerId = "10.2.10.1"
*.CoreRouter1.routerId = "10.1.3.2"
*.CoreRouter2.routerId = "10.1.4.2"
*.CoreRouter3.routerId = "10.1.5.2"

# Host IP Addresses
#*.Tx1.ppp[0].ipv4.address = "10.0.0.1"
#*.Tx2.ppp[0].ipv4.address = "10.0.0.2"
#*.Tx3.ppp[0].ipv4.address = "10.0.0.3"
#*.Rx1.ppp[0].ipv4.address = "10.2.0.1"
#*.Rx2.ppp[0].ipv4.address = "10.2.0.2"
#*.Rx3.ppp[0].ipv4.address = "10.2.0.3"
#*.LER_Ingress.ppp[0].ipv4.address = "10.0.1.1"
#*.LER_Ingress.ppp[1].ipv4.address = "10.0.1.2"
#*.LER_Ingress.ppp[2].ipv4.address = "10.0.1.3"
#*.LER_Ingress.ppp[3].ipv4.address = "10.1.3.1"
#*.LER_Ingress.ppp[4].ipv4.address = "10.1.4.1"
#*.LER_Ingress.ppp[5].ipv4.address = "10.1.5.1"
#*.LER_Egress.ppp[0].ipv4.address = "10.2.1.1"
#*.LER_Egress.ppp[1].ipv4.address = "10.2.1.2"
#*.LER_Egress.ppp[2].ipv4.address = "10.2.1.3"
#*.LER_Egress.ppp[3].ipv4.address = "10.2.3.1"
#*.LER_Egress.ppp[4].ipv4.address = "10.2.4.1"
#*.LER_Egress.ppp[5].ipv4.address = "10.2.5.1"
#*.CoreRouter1.ppp[0].ipv4.address = "10.1.3.2"
#*.CoreRouter1.ppp[1].ipv4.address = "10.2.3.2"
#*.CoreRouter2.ppp[0].ipv4.address = "10.1.4.2"
#*.CoreRouter2.ppp[1].ipv4.address = "10.2.4.2"
#*.CoreRouter3.ppp[0].ipv4.address = "10.1.5.2"
#*.CoreRouter3.ppp[1].ipv4.address = "10.2.5.2"

# RSVP-TE configuration
**.LER_Ingress.rsvp.traffic = xmldoc("LER_Ingress_traffic.xml")
**.LER_Ingress.classifier.config = xmldoc("LER_Ingress_fec.xml")

# Routing tables
**.LER_Ingress.ipv4.routingTable.routingFile = "LER_Ingress.rt"
**.LER_Egress.ipv4.routingTable.routingFile = "LER_Egress.rt"
**.CoreRouter1.ipv4.routingTable.routingFile = "CoreRouter1.rt"
**.CoreRouter2.ipv4.routingTable.routingFile = "CoreRouter2.rt"
**.CoreRouter3.ipv4.routingTable.routingFile = "CoreRouter3.rt"
**.Tx1.ipv4.routingTable.routingFile = "Tx1.rt"
**.Tx2.ipv4.routingTable.routingFile = "Tx2.rt"
**.Tx3.ipv4.routingTable.routingFile = "Tx3.rt"
**.Rx1.ipv4.routingTable.routingFile = "Rx1.rt"
**.Rx2.ipv4.routingTable.routingFile = "Rx2.rt"
**.Rx3.ipv4.routingTable.routingFile = "Rx3.rt"

# Scenario
**.scenarioManager.script = xmldoc("MPLSDynamic_scenario.xml")

[Config MPLSDynamic_Test1]
extends = MPLSDynamicBase

description = "Test with link failure on primary path at t=20s"

[Config MPLSDynamic_Congestion]
extends = MPLSDynamicBase
description = "Test with congestion on primary path"

# Generate additional background traffic to cause congestion
**.Tx1.app[0].sendInterval = 0.5ms  # Increased traffic rate
**.Tx2.app[0].sendInterval = 1ms
**.Tx3.app[0].sendInterval = 2ms

[Config MPLSDynamic_MultipleFailures]
extends = MPLSDynamicBase
description = "Test with multiple link failures"
sim-time-limit = 70s
**.Tx*.app[0].stopTime = 119s

#==============================================================================
# MPLSMesh Network Configuration
#==============================================================================

[Config MPLSMesh_Config]
extends = MPLSCommon, ApplicationsCommon
network = insotu.simulations.MPLSMesh
sim-time-limit = 60s
description = "Mesh topology with redundant paths"

# Visualization
**.visualizer.*.displayLinks = true
**.visualizer.*.displayRoutes = true

# Network Configurator
*.ipv4NetworkConfigurator.addStaticRoutes = false
*.ipv4NetworkConfigurator.dumpConfig = "mesh_config.xml"

# Router IDs (includes CoreRouter4)
*.LER_Ingress.routerId = "10.1.1.1"
*.LER_Egress.routerId = "10.2.1.1"
*.CoreRouter1.routerId = "10.3.1.1"
*.CoreRouter2.routerId = "10.3.2.1"
*.CoreRouter3.routerId = "10.3.3.1"
*.CoreRouter4.routerId = "10.3.4.1"

# Scenario Configuration
**.scenarioManager.script = xmldoc("MPLSMesh_scenario.xml")

# Application configuration (no stop time for mesh)
**.Tx*.app[0].stopTime = 59s
